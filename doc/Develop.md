## Создание нового компонента

### Введение

В этом разделе мы считаем, что для вашего языка программирования уже существует библиотека с компонентом.

На текущий момент библиотеки разработаны для следующих языков программирования:
  * [haskell](https://github.com/biocad/mq-component-hs);
  * [python](https://github.com/biocad/mq-component-py).
  
Если вашего языка программирования среди перечисленных нет, вам придётся перейти в раздел ["Разработка компонента на новом языке"](NewLanguage.md) и разработать соответствующую библиотеку.

Разработка нового компонента включает следующие этапы:
  * написание кода;
  * тестирование;
  * документирование;
  * запуск компонента в тестовом окружении;
  * запуск компонента в рабочем окружении.
  
### Написание кода

Правила, примеры и рекомендации по написанию кода можно посмотреть в соответствующих библиотеках:
  * [haskell](https://github.com/biocad/mq-component-hs/blob/master/doc/Develop.md);
  * [python](https://github.com/biocad/mq-component-py/blob/master/doc/Develop.md).
  
### Тестирование

После написания кода наступает этап локального тестирования.
Прежде всего, нам понадобится локально запущенное ["одно место"](Scheduler.md), а также ["контроллер"](Controller.md), если задачи заданного типа должны распределяться между разрабатываемыми компонентами через контроллер, а не поступать напрямую из "одного места".
Как быстро запустить эти компоненты читай в разделе ["MoniQue за 5 минут"](5minutes.md).

На текущий момент тестирование компонента реализуется с помощью библиотеки [mq-jobcontrol](https://github.com/biocad/mq-jobcontrol).

> NB: в данный момент jobcontrol не позволит протестировать компонент, который просто генерирует сообщения.
> В ближайшее время эта функциональность будет доработана.

Примеры использования jobcontrol можно подглядеть [тут](https://github.com/biocad/mq-jobcontrol#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B).

### Документирование

К процессу документирования нужно подойти с особой тщательностью, так как он является одним из основных положений MoniQue.
Документировать необходимо следующие вещи.

#### Код

Разработчики MoniQue призывают сопровождать разрабатываемый код документацией.
Степень подробности документации определяется необходимостью, здравым смыслом и внутренним чувством прекрасного у разработчика.

#### Запуск компонента

В README каждого разрабатываемого компонента должны быть описаны шаги его сборки и запуска.
Степень подробноси должна быть достаточной для квалифицированного специалиста, чтобы позволить ему успешно пройти по описанным шагам.

Разработчики MoniQue настоятельно рекомендуют придерживаться правил, описанных в документе ["Конфигурационный файл"](ConfigJson.md).
Это позволит сделать запуск всех компонентов унифицированным.

Если в одном репозитории описаны несколько компонентов, под каждый из них должна быть соответствующая инструкция.

#### Docker

Вполне возможно, что для кроссплатформеного запуска компонента будет использоваться инструмент [Docker](https://www.docker.com/).
В зтом случае разработчики MoniQue советуют располагать Dockerfile в папке docker, а в README описывать необходимые команды для запуска компонента через Docker.

#### Запуск стороннего окружения

В случае, если разрабатываемый компонент зависит от стороннего окружения (сервисы, базы данных, и т.д.), в README должно быть описано то, как соответствующее окружение запускать.
Если данная документация имеется в каком-либо другом месте, на него должна быть приведена ссылка.

#### Компонент в api.biocad.ru

Все описанные выше пункты являются полезными рекомендациями, которых стоит придерживаться.
В них создатели MoniQue уповают на сознательность и ответственность разработчиков и менеджеров.

Этот и следующие пункты описывают те разделы документации (в рамках компании BIOCAD), в актуальности которых могут быть заинтересованы сторонние компоненты и приложения.
Поэтому актуальность и качеcтво документации в этом и следующем разделах будет дополнительно проверяться и валидироваться.

Площадка, которая определяет общее место документации всех компонентов, располагается по [этому](https://api.biocad.ru/) адресу.

В соответствующем разделе для каждого компонента есть описание следующих пунктов:
  * для чего он предназначен;
  * с какими сообщениями умеет работать.
  
При разработке нового компонента в соответствующем разделе необходимо завести его описание.

#### Сообщения в api.biocad.ru

В соответствующем разделе [api.biocad.ru](https://api.biocad.ru) для каждого сообщения описывается следующее:
  * тип сообщения;
  * спецификация;
  * кодировка;
  * порт (см. комментарий ниже);
  * пример сообщения.
  
> Комментарий к полю "порт": его будет использовать [контроллер](Controller.md).
> Если для сообщения поле "порт" указано, то в автоматическом режиме для данного сообщения будет запущен контроллер с указанным в документации портом.

Если используемое компонентом сообщение уже описано, повторно его описывать не требуется.

**NB**: если на сообщение нет документации в api.biocad.ru, то "одно место" (Scheduler) в рабочем окружении не будет пропускать такое сообщение далее.

### Запуск компонента в тестовом окружении

После того как пройдены все предыдующие этапы, наступает черёд тестирования компонента в общей очереди (но в тестовом окружении).
Тестовое окружение является в некотором смысле копией рабочего окружения, на котором производятся отладочные работы.
Поэтому все компоненты должны быть запущены как в тестовом, так и в рабочем окружениях.

Хорошей практикой является запуск компонента в тестовом окружении с помощью CI.

Обратим внимание, что так как в тестовом окружении должны быть запущены все компоненты, то можно проверить работоспособность даже "межпроектного" взаимодействия компонентов, когда компонент из одного проекта общается с компонентом из другого проекта.

**В компании BIOCAD хост "одного места" для тестового окружения: mq-test.bi.biocad.ru**.
Порты тестового окружения совпадают с теми, что указаны в файле [config.json](../config.json) репозитория.

### Запуск компонента в рабочем окружении

После проведения отладки и проверки компонента в тестовом окружении, можно запускать компонент в рабочем окружении.

Если процесс CI настроен правильно, то это должно свестись к указанию другого хоста MoniQue, а также параметров для сторонних окружений.

**В компании BIOCAD хост "одного места" для рабочего окружения: mq-prod.bi.biocad.ru**.
Порты рабочего окружения совпадают с теми, что указаны в файле [config.json](../config.json) репозитория.

### Резюмируя

В данном документе описаны все шаги, которые требуются от разработчика компонента.
Если вам кажется, что какой-нибудь из пунктов можно улучшить или дополнить - можете связаться в разработчиками MoniQue.
Они с радостью выслушают ваше предложение.
